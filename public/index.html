<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>CRUD Doctores & Pacientes</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    /* ======= CSS elegante celeste ======= */
    :root {
      --celeste: #6ec5ff;
      --celeste-claro: #d9efff;
      --texto: #343a40;
    }

    body { background: #f6f8fb; color: var(--texto); font-family: 'Segoe UI', sans-serif; }
    .navbar { background-color: var(--celeste) !important; box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
    .navbar-brand { font-weight: 700; color: #fff !important; display: flex; align-items: center; gap: 8px; font-size: 1.15rem; }

    .card { border: 0; box-shadow: 0 6px 22px rgba(0,0,0,.06); border-radius: 14px; }
    .tab-pane { background: #fff; border-radius: 0 0 16px 16px; }
    .form-section-title { font-size: .95rem; font-weight: 600; color: #495057; text-transform: uppercase; letter-spacing: .6px; }
    .divider { height: 1px; background: #e9ecef; margin: .75rem 0 1rem; }

    /* Botones principales */
    .btn-primary {
      background-color: var(--celeste);
      border-color: var(--celeste);
      font-weight: 500;
    }
    .btn-primary:hover {
      background-color: #53b7fb;
      border-color: #53b7fb;
    }

    /* Encabezados de tabla */
    .table thead th {
      background: var(--celeste);
      color: #fff;
      border: none;
      position: sticky;
      top: 0;
      z-index: 1;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: .5px;
    }

    .table tbody tr:hover { background-color: var(--celeste-claro); }

    .badge-soft {
      background: var(--celeste-claro);
      color: var(--celeste);
      border: 1px dashed var(--celeste);
      font-weight: 500;
    }

    .img-thumb {
      width: 56px;
      height: 56px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid var(--celeste-claro);
    }

    .btn-icon {
      padding: .35rem .55rem;
      border-radius: 6px;
    }

    .btn-outline-primary {
      border-color: var(--celeste);
      color: var(--celeste);
    }
    .btn-outline-primary:hover {
      background-color: var(--celeste);
      color: white;
    }

    .btn-outline-danger {
      border-color: #ff6b6b;
      color: #ff6b6b;
    }
    .btn-outline-danger:hover {
      background-color: #ff6b6b;
      color: white;
    }

    .form-floating>label { color: #6c757d; }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark">
    <div class="container">
      <span class="navbar-brand">
        <i class="bi bi-lungs-fill"></i> CRUD Doctores & Pacientes
      </span>
    </div>
  </nav>

  <div class="container py-4">
    <ul class="nav nav-tabs" id="tabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-doctores" type="button" role="tab">Doctores</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-pacientes" type="button" role="tab">Pacientes</button>
      </li>
    </ul>

    <div class="tab-content border-start border-end border-bottom p-3">
      <!-- ================= DOCTORES ================= -->
      <div class="tab-pane fade show active" id="tab-doctores" role="tabpanel">
        <div class="row g-3">
          <div class="col-12 col-lg-4">
            <div class="card p-3">
              <div class="form-section-title">Gestión de Doctores</div>
              <div class="divider"></div>
              <form id="form-doctor" class="row g-3">
                <input type="hidden" id="doc-id">
                <div class="col-12">
                  <div class="form-floating">
                    <input id="doc-nombre" class="form-control" placeholder="Nombre del doctor" required>
                    <label for="doc-nombre">Nombre</label>
                  </div>
                </div>
                <div class="col-12">
                  <div class="form-floating">
                    <input id="doc-especialidad" class="form-control" placeholder="Especialidad" required>
                    <label for="doc-especialidad">Especialidad</label>
                  </div>
                </div>
                <div class="d-flex gap-2">
                  <button class="btn btn-primary" type="submit" id="doc-guardar">Guardar</button>
                  <button class="btn btn-secondary" type="button" id="doc-cancel" hidden>Cancelar</button>
                </div>
              </form>
            </div>
          </div>

          <div class="col-12 col-lg-8">
            <div class="card p-3">
              <div class="d-flex justify-content-between align-items-center">
                <div class="form-section-title mb-0">Lista de Doctores</div>
                <span class="badge badge-soft" id="doc-count">0 doctores</span>
              </div>
              <div class="table-responsive mt-3" style="max-height: 420px;">
                <table class="table table-sm align-middle">
                  <thead><tr><th>ID</th><th>Nombre</th><th>Especialidad</th><th class="text-end">Acciones</th></tr></thead>
                  <tbody id="tbody-doctores"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ================= PACIENTES ================= -->
      <div class="tab-pane fade" id="tab-pacientes" role="tabpanel">
        <div class="row g-3">
          <div class="col-12 col-xxl-5">
            <div class="card p-3">
              <div class="form-section-title">Gestión de Pacientes</div>
              <div class="divider"></div>
              <form id="form-paciente" class="row g-3" enctype="multipart/form-data">
                <input type="hidden" id="pac-id">
                <div class="col-12">
                  <div class="form-floating">
                    <input id="pac-nombre" class="form-control" placeholder="Nombre del paciente" required>
                    <label for="pac-nombre">Nombre</label>
                  </div>
                </div>
                <div class="col-6">
                  <div class="form-floating">
                    <input id="pac-edad" type="number" min="0" class="form-control" placeholder="Edad" required>
                    <label for="pac-edad">Edad</label>
                  </div>
                </div>
                <div class="col-6">
                  <div class="form-floating">
                    <select id="pac-doctor" class="form-select" required></select>
                    <label for="pac-doctor">Doctor</label>
                  </div>
                </div>
                <div class="col-12">
                  <label class="form-label">Foto (opcional)</label>
                  <input id="pac-foto" type="file" accept="image/*" class="form-control">
                  <div class="mt-2">
                    <img id="preview" class="img-thumb d-none" alt="preview">
                  </div>
                </div>
                <div class="d-flex gap-2">
                  <button class="btn btn-primary" type="submit" id="pac-guardar">Guardar</button>
                  <button class="btn btn-secondary" type="button" id="pac-cancel" hidden>Cancelar</button>
                </div>
              </form>
            </div>
          </div>

          <div class="col-12 col-xxl-7">
            <div class="card p-3">
              <div class="d-flex justify-content-between align-items-center">
                <div class="form-section-title mb-0">Lista de Pacientes</div>
                <span class="badge badge-soft" id="pac-count">0 pacientes</span>
              </div>
              <div class="table-responsive mt-3" style="max-height: 520px;">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr>
                      <th>ID</th><th>Nombre</th><th>Edad</th><th>Doctor</th><th>Especialidad</th><th>Foto</th><th class="text-end">Acciones</th>
                    </tr>
                  </thead>
                  <tbody id="tbody-pacientes"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div> 
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const API = location.origin + "/api";
    const $ = s => document.querySelector(s);

    async function fetchJSON(url, opts) {
      const r = await fetch(url, opts);
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }

    // ---------- DOCTORES ----------
    async function loadDoctores() {
      const rows = await fetchJSON(API + "/doctores");
      $("#tbody-doctores").innerHTML = rows.map(d => `
        <tr>
          <td>${d.id_doctor}</td>
          <td>${d.nombre}</td>
          <td>${d.especialidad}</td>
          <td class="text-end">
            <button class="btn btn-outline-primary btn-icon" onclick='editDoctor(${JSON.stringify(d.id_doctor)}, ${JSON.stringify(d.nombre)}, ${JSON.stringify(d.especialidad)})'><i class="bi bi-pen-fill"></i></button>
            <button class="btn btn-outline-danger btn-icon ms-1" onclick="delDoctor(${d.id_doctor})"><i class="bi bi-trash3-fill"></i></button>
          </td>
        </tr>
      `).join("");
      $("#doc-count").textContent = rows.length + " doctores";
      const sel = $("#pac-doctor");
      sel.innerHTML = '<option disabled selected>Seleccione...</option>' +
        rows.map(x => `<option value="${x.id_doctor}">${x.nombre} — ${x.especialidad}</option>`).join("");
    }

    async function saveDoctor(e) {
      e.preventDefault();
      const id = $("#doc-id").value;
      const body = JSON.stringify({
        nombre: $("#doc-nombre").value.trim(),
        especialidad: $("#doc-especialidad").value.trim()
      });
      const headers = { "Content-Type": "application/json" };
      if (id) await fetchJSON(API + "/doctores/" + id, { method: "PUT", headers, body });
      else await fetchJSON(API + "/doctores", { method: "POST", headers, body });
      e.target.reset(); $("#doc-id").value = ""; $("#doc-cancel").hidden = true;
      await loadDoctores();
    }

    function editDoctor(id, nombre, especialidad) {
      $("#doc-id").value = id;
      $("#doc-nombre").value = nombre;
      $("#doc-especialidad").value = especialidad;
      $("#doc-cancel").hidden = false;
    }

    async function delDoctor(id) {
      if (!confirm("¿Eliminar doctor?")) return;
      try {
        await fetchJSON(API + "/doctores/" + id, { method: "DELETE" });
        await loadDoctores(); await loadPacientes();
      } catch { alert("No se puede eliminar. Tiene pacientes asociados."); }
    }

    $("#doc-cancel").addEventListener("click", () => { $("#form-doctor").reset(); $("#doc-id").value=""; $("#doc-cancel").hidden=true; });
    $("#form-doctor").addEventListener("submit", saveDoctor);

    // ---------- PACIENTES ----------
    async function loadPacientes() {
      const rows = await fetchJSON(API + "/pacientes");
      $("#tbody-pacientes").innerHTML = rows.map(p => `
        <tr>
          <td>${p.id_paciente}</td>
          <td>${p.nombre}</td>
          <td>${p.edad}</td>
          <td>${p.doctor?.nombre ?? "-"}</td>
          <td>${p.doctor?.especialidad ?? "-"}</td>
          <td>${p.foto ? `<img class="img-thumb" src="/uploads/${p.foto}">` : "-"}</td>
          <td class="text-end">
            <button class="btn btn-outline-primary btn-icon" onclick='editPaciente(${JSON.stringify(p)})'><i class="bi bi-pen-fill"></i></button>
            <button class="btn btn-outline-danger btn-icon ms-1" onclick="delPaciente(${p.id_paciente})"><i class="bi bi-trash3-fill"></i></button>
          </td>
        </tr>
      `).join("");
      $("#pac-count").textContent = rows.length + " pacientes";
    }

    function editPaciente(p) {
      $("#pac-id").value = p.id_paciente;
      $("#pac-nombre").value = p.nombre;
      $("#pac-edad").value = p.edad;
      $("#pac-doctor").value = p.id_doctor;
      if (p.foto) { $("#preview").src = "/uploads/" + p.foto; $("#preview").classList.remove("d-none"); }
      else $("#preview").classList.add("d-none");
      $("#pac-cancel").hidden = false;
    }

    async function savePaciente(e) {
      e.preventDefault();
      const id = $("#pac-id").value;
      const fd = new FormData();
      fd.append("nombre", $("#pac-nombre").value.trim());
      fd.append("edad", $("#pac-edad").value);
      fd.append("id_doctor", $("#pac-doctor").value);
      const file = $("#pac-foto").files[0]; if (file) fd.append("foto", file);
      if (id) await fetch(API + "/pacientes/" + id, { method: "PUT", body: fd });
      else await fetch(API + "/pacientes", { method: "POST", body: fd });
      $("#form-paciente").reset(); $("#pac-id").value=""; $("#pac-cancel").hidden=true; $("#preview").classList.add("d-none");
      await loadPacientes();
    }

    async function delPaciente(id) {
      if (!confirm("¿Eliminar paciente?")) return;
      await fetchJSON(API + "/pacientes/" + id, { method: "DELETE" });
      await loadPacientes();
    }

    $("#pac-cancel").addEventListener("click", () => { $("#form-paciente").reset(); $("#pac-id").value=""; $("#pac-cancel").hidden=true; $("#preview").classList.add("d-none"); });
    $("#form-paciente").addEventListener("submit", savePaciente);

    (async()=>{await loadDoctores(); await loadPacientes();})();
  </script>
</body>
</html>
